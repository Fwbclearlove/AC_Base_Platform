(19)中华人民共和国国家知识产权局

(12)发明专利

(10)授权公告号 (45)授权公告日

(21)申请号 201810885541.5

(22)申请日 2018.08.06

(65)同一申请的已公布的文献号

申请公布号 CN 109165309 A

(43)申请公布日 2019.01.08

(73)专利权人 北京邮电大学

地址 100876 北京市海淀区西土城路10号

(72)发明人 李睿凡 陈光 都金超 李鑫 王宁 梁昊雨 李亚洲 朱正源 王小捷

(74)专利代理机构 北京柏杉松知识产权代理事

务所(普通合伙) 11413 代理人 李欣 马敬

(51)Int.Cl.

G06F 16/55(2019.01)

G06F 16/583(2019.01)

(56)对比文件

CN 108121781 A,2018.06.05 CN 106886553 A,2017.06.23 CN 104156438 A,2014.11.19 CN 107918640 A,2018.04.17 CN 106845528 A,2017.06.13 US 2014372439 A1,2014.12.18 WO 2013147170 A1,2013.10.03 WO 0111489 A2,2001.02.15 常小红等.一种基于聚类的图像检索方法. 《医疗卫生装备》.2013,第34卷(第8期) ,4-6.

丁世飞等.基于自适应Nyström 采样的大数 据谱聚类算法.《软件学报》.2014,(第9期) , 2037-2049.

审查员 刘仙凤

(54)发明名称

负例训练样本采集方法、装置及模型训练方 法、装置 (57)摘要

本发明实施例提供了负例训练样本采集方 法和模型训练方法。负例训练样本采集方法包 括：对表示向量进行聚类，确定目标向量所属的 第一聚类及中心，从而确定候选聚类的目标概 率，从候选向量中抽取多个第二聚类，并从每个 第二聚类中获取一个负例训练样本。模型训练方 法包括：确定多组训练样本；基于训练样本对初 始图像检索模型进行训练，在迭代到一定次数 时，若模型没有训练完成，重新确定训练样本继 续训练，直至模型训练完成。与现有技术相比，应 用本发明实施例提供的方案，采集负例训练样本 时，可以在兼顾各个不同难度水平的负例训练样 本的同时，优先采集“难”的负例训练样本，进而 提高基于负例训练样本训练得到的图像检索模 型的准确率。

权利要求书3页 说明书18页 附图3页

CN 109165309 B 2020.10.16

CN 109165309 B

1.一种负例训练样本采集方法，其特征在于，所述方法包括： 将用于负例训练样本采集的多张图像输入到预设的初始图像检索模型中，得到各张图 像对应的表示向量，并将所得到的表示向量构成样本集合；

对所述样本集合包括的多个表示向量进行聚类，得到多个聚类，并确定每个聚类的聚 类中心；

针对每个目标向量，确定该目标向量所属的第一聚类，其中，任一目标向量为：所述多 张图像中的一张目标图像对应的表示向量；

针对每个目标向量，基于该目标向量所属的第一聚类的聚类中心，确定该目标向量所 对应多个候选聚类中的每个聚类的目标概率；其中，所述多个候选聚类为：所述多个聚类 中，除该目标向量所属的第一聚类外的所有聚类，任一聚类的目标概率为该聚类作为该目 标向量所属的第一聚类的近邻聚类的概率；

针对每个目标向量，基于所确定的目标概率，对该目标向量所对应多个候选聚类执行 多次聚类抽取操作，得到该目标向量对应的多个第二聚类；

针对每个目标向量，在该目标向量对应的每个第二聚类中获取一个表示向量，作为该 目标向量所对应的负例训练样本。

2.根据权利要求1所述的方法，其特征在于，所述针对每个目标向量，确定该目标向量 所属的第一聚类的步骤，包括：

针对每个目标向量，确定该目标向量与所述每个聚类的聚类中心所对应的向量的距 离，将距离最近的聚类确定为该目标向量所属的第一聚类。

3.根据权利要求1所述的方法，其特征在于，所述针对每个目标向量，基于该目标向量 所属的第一聚类的聚类中心，确定该目标向量所对应多个候选聚类中的每个聚类的目标概 率的步骤，包括：

针对每个目标向量，根据第一公式，计算该目标向量所对应多个候选聚类中的每个聚 类的目标概率，其中，所述第一公式为：

其中，P(m,i)为针对第i个目标向量，所对应多个候选聚类中，第m个聚类作为该目标向 量所属的第一聚类的近邻聚类的概率，T为转置运算；

ci为第i个目标向量所属的第一聚类的聚类中心，cm为第i个目标向量所对应多个候选 聚类中，第m个聚类的聚类中心，cj为第i个目标向量所对应多个候选聚类中，第j个聚类的 聚类中心，M为所述多个聚类的数量，1≤m≤M且m≠i。

4.根据权利要求1所述的方法，其特征在于，所述针对每个目标向量，在该目标向量对 应的每个第二聚类中获取一个表示向量，作为该目标向量所对应的负例训练样本的步骤， 包括：

针对每个目标向量，在该目标向量对应的每个第二聚类中随机获取一个表示向量，作 为该目标向量所对应的负例训练样本；或，

针对每个目标向量，将该目标向量对应的每个第二聚类中与该第二聚类的聚类中心的 距离为预设距离的表示向量，确定为该目标向量所对应的负例训练样本。

权 利 要 求 书 1/3 页

CN 109165309 B

5.一种基于权利要求1-4任一项负例训练样本采集方法的模型训练方法，其特征在于， 所述方法包括：

在预设的初始图像检索模型获得的样本集合中，获取多个目标向量，并确定每个目标 向量所对应的一个正例训练样本；

针对所述每个目标向量，在所述样本集合中，确定该目标向量所对应的多个负例训练 样本；

确定多组训练样本，其中，每个训练样本包括一个目标向量、该目标向量所对应的一个 正例训练样本和该目标向量所对应的多个负例训练样本；

基于所述多组训练样本对所述预设的初始图像检索模型进行训练，并从零开始对迭代 次数进行计数，作为目标次数；

当所述目标次数达到预设数值时，判断是否满足训练停止条件； 如果满足，停止模型训练，得到训练完成的图像检索模型； 否则，将所述目标次数清零，返回所述针对所述每个目标向量，在所述样本集合中，确 定该目标向量所对应的多个负例训练样本的步骤。

6.根据权利要求5所述的方法，其特征在于，所述当所述目标次数达到预设数值时，判 断是否满足训练停止条件的步骤，包括：

当所述目标次数达到预设数值时，判断预设损失函数是否满足预设阈值。 7.根据权利要求6所述的方法，其特征在于，所述预设损失函数为：

其中，Γ(θ)为所述预设损失函数的函数值，γ为平滑因子； 针对每组训练样本，xq为该训练样本中的目标向量，x0为该训练样本中的正例训练样 本，xi为该训练样本中的第i个负例训练样本，1≤i≤n，n为该训练样本中负例训练样本的 数量；R(x0,xq)为该训练样本中x0与xq的相似度；R(xi,xq)为该训练样本中xi与xq的相似度。

8.根据权利要求7所述的方法，其特征在于， R(x0,xq)＝f(x0)Tf(xq) R(xi,xq)＝f(xi)Tf(xq) 其中，f为所述初始图像检索模型将图像映射到该图像所对应的表示向量的映射函数， T为转置运算。

9.一种负例训练样本采集装置，其特征在于，所述装置包括： 样本集合构成模块，用于将用于负例训练样本采集的多张图像输入到预设的初始图像 检索模型中，得到各张图像对应的表示向量，并将所得到的表示向量构成样本集合；

聚类中心确定模块，用于对所述样本集合包括的多个表示向量进行聚类，得到多个聚 类，并确定每个聚类的聚类中心；

第一聚类确定模块，用于针对每个目标向量，确定该目标向量所属的第一聚类，其中， 任一目标向量为：所述多张图像中的一张目标图像对应的表示向量；

目标概率确定模块，用于针对每个目标向量，基于该目标向量所属的第一聚类的聚类 中心，确定该目标向量所对应多个候选聚类中的每个聚类的目标概率；其中，所述多个候选 聚类为：所述多个聚类中，除该目标向量所属的第一聚类外的所有聚类，任一聚类的目标概

权 利 要 求 书 2/3 页

CN 109165309 B

率为该聚类作为该目标向量所属的第一聚类的近邻聚类的概率；

第二聚类确定模块，用于针对每个目标向量，基于所确定的目标概率，对该目标向量所 对应多个候选聚类执行多次聚类抽取操作，得到该目标向量对应的多个第二聚类；

负例训练样本获取模块，用于针对每个目标向量，在该目标向量对应的每个第二聚类 中获取一个表示向量，作为该目标向量所对应的负例训练样本。

10.一种基于权利要求1-4任一项负例训练样本采集方法的模型训练装置，其特征在 于，所述装置包括：

正例训练样本确定模块，用于在预设的初始图像检索模型获得的样本集合中，获取多 个目标向量，并确定每个目标向量所对应的一个正例训练样本；

负例训练样本确定模块，用于针对所述每个目标向量，在所述样本集合中，确定该目标 向量所对应的多个负例训练样本；

训练样本组确定模块，用于确定多组训练样本，其中，每个训练样本包括一个目标向 量、该目标向量所对应的一个正例训练样本和该目标向量所对应的多个负例训练样本；

模型训练模块，用于基于所述多组训练样本对所述预设的初始图像检索模型进行训 练，并从零开始对迭代次数进行计数，作为目标次数；

目标次数判断模块，用于当所述目标次数达到预设数值时，判断是否满足训练停止条 件，如果满足，触发模型获得模块，否则，触发清零模块和所述负例训练样本确定模块；

所述模型获得模块，用于停止模型训练，得到训练完成的图像检索模型； 所述清零模块，用于将所述目标次数清零。

权 利 要 求 书 3/3 页

CN 109165309 B

负例训练样本采集方法、装置及模型训练方法、装置

[0001] 本发明涉及图像检索技术领域，特别是涉及一种负例训练样本采集方法、装置及 电子设备，以及一种模型训练方法、装置及电子设备。

[0002] 当前，随着计算机计算能力的不断增强，各种深度学习模型的应用越来越广泛，用 于图像检索的深度学习神经网络模型是具有重要作用的深度学习模型之一，例如，在数字 化图书馆、医疗诊断、网络购物等领域，用于图像检索的深度学习神经网络模型具有非常重 要的地位。为了描述简便，上述用于图像检索的深度学习神经网络模型可以简称为图像检 索模型。

[0003] 为了对图像检索模型进行训练，需要首先确定用于训练该模型的多张图像中一定 数量的目标图像，然后确定各张目标图像对应的负例训练样本和正例训练样本，进而利用 各张目标图像，以及各张目标图像对应负例训练样本和正例训练样本，实现图像检索模型 的训练。其中，任一目标图像对应的负例训练样本为对目标图像进行查询时得到的错误查

询结果，任一目标图像对应的正例训练样本为对目标图像进行查询时得到的正确查询结 果。

[0004] 现有技术中，负例训练样本采集方法的处理思路是：在确定目标图像对应的负例 训练样本时，从用于训练该模型的多张图像中选取负例图像，将选取到的负例图像确定为 该目标图像对应的负例训练样本，其中，负例图像为对目标图像进行查询时得到的错误图 像。如图1所示，每个目标图像周围存在多种不同难度的负例图像，其中，一些负例图像很容 易与目标图像区分，一些负例图像则很难与目标图像区分。因此，如何采集有效的负例训练 样本对训练得到图像检索模型具有重要作用。

[0005] 具体的，现有技术中，常用的负例训练样本采集方法主要有两种。一种是采集“难” 的负例训练样本，这些负例训练样本在样本空间中和目标图像的距离很近，因此也很难被 区分，但是这种采集方法会导致负例采样不是在整个样本空间中进行，而只聚焦于样本空 间中的一个局部视角。另一种是均匀随机采集负例训练样本，然而，这种负例采样方法虽然 能够有机会得到所有难度水平的负例训练样本，但是由于“难”的负例训练样本的训练不充 分，从而使训练得到的图像检索模型存在局部最优。进而，在基于上述两种方法采集到的负 例训练样本对模型进行训练时，训练得到的图像检索模型的检索准确率较低。

[0006] 本发明实施例的目的在于提供一种负例训练样本采集方法、装置及电子设备，以 实现采集负例训练样本时，在兼顾各个不同难度水平的负例训练样本的同时，可以优先采 集“难”的负例训练样本。

[0007] 本发明实施例还提供了一种模型训练方法、装置及电子设备，以实现在上述负例 训练样本采集方法获得负例训练样本的基础上，提高训练得到的图像检索模型的检索准确

说 明 书 1/18 页

CN 109165309 B

[0008] 具体技术方案如下：

[0009] 第一方面，本发明实施例提供了一种负例训练样本采集方法，所述方法包括：

[0010] 将用于负例训练样本采集的多张图像输入到预设的初始图像检索模型中，得到各 张图像对应的表示向量，并将所得到的表示向量构成样本集合；

[0011] 对所述样本集合包括的多个表示向量进行聚类，得到多个聚类，并确定每个聚类 的聚类中心；

[0012] 针对每个目标向量，确定该目标向量所属的第一聚类，其中，任一目标向量为：所 述多张图像中的一张目标图像对应的表示向量；

[0013] 针对每个目标向量，基于该目标向量所属的第一聚类的聚类中心，确定该目标向 量所对应多个候选聚类中的每个聚类的目标概率；其中，所述多个候选聚类为：所述多个聚 类中，除该目标向量所属的第一聚类外的所有聚类，任一聚类的目标概率为该聚类作为该 目标向量所属的第一聚类的近邻聚类的概率；

[0014] 针对每个目标向量，基于所确定的目标概率，对该目标向量所对应多个候选聚类 执行多次聚类抽取操作，得到该目标向量对应的多个第二聚类；

[0015] 针对每个目标向量，在该目标向量对应的每个第二聚类中获取一个表示向量，作 为该目标向量所对应的负例训练样本。

[0016] 第二方面，本发明实施例提供了一种基于上述负例训练样本采集方法的模型训练 方法，所述方法包括：

[0017] 在预设的初始图像检索模型获得的样本集合中，获取多个目标向量，并确定每个 目标向量所对应的一个正例训练样本；

[0018] 针对所述每个目标向量，在所述样本集合中，确定该目标向量所对应的多个负例 训练样本；

[0019] 确定多组训练样本，其中，每个训练样本包括一个目标向量、该目标向量所对应的 一个正例训练样本和该目标向量所对应的多个负例训练样本；

[0020] 基于所述多组训练样本对所述预设的初始图像检索模型进行训练，并从零开始对 迭代次数进行计数，作为目标次数；

[0021] 当所述目标次数达到预设数值时，判断是否满足训练停止条件；

[0022] 如果满足，停止模型训练，得到训练完成的图像检索模型；

[0023] 否则，将所述目标次数清零，返回所述针对所述每个目标向量，在所述样本集合 中，确定该目标向量所对应的多个负例训练样本的步骤。

[0024] 第三方面，本发明实施例提供了一种负例训练样本采集装置，所述装置包括：

[0025] 样本集合构成模块，用于将用于负例训练样本采集的多张图像输入到预设的初始 图像检索模型中，得到各张图像对应的表示向量，并将所得到的表示向量构成样本集合；

[0026] 聚类中心确定模块，用于对所述样本集合包括的多个表示向量进行聚类，得到多 个聚类，并确定每个聚类的聚类中心；

[0027] 第一聚类确定模块，用于针对每个目标向量，确定该目标向量所属的第一聚类，其 中，任一目标向量为：所述多张图像中的一张目标图像对应的表示向量；

[0028] 目标概率确定模块，用于针对每个目标向量，基于该目标向量所属的第一聚类的

说 明 书 2/18 页

CN 109165309 B

聚类中心，确定该目标向量所对应多个候选聚类中的每个聚类的目标概率；其中，所述多个 候选聚类为：所述多个聚类中，除该目标向量所属的第一聚类外的所有聚类，任一聚类的目 标概率为该聚类作为该目标向量所属的第一聚类的近邻聚类的概率；

[0029] 第二聚类确定模块，用于针对每个目标向量，基于所确定的目标概率，对该目标向 量所对应多个候选聚类执行多次聚类抽取操作，得到该目标向量对应的多个第二聚类；

[0030] 负例训练样本获取模块，用于针对每个目标向量，在该目标向量对应的每个第二 聚类中获取一个表示向量，作为该目标向量所对应的负例训练样本。

[0031] 第四方面，本发明实例提供了一种基于上述负例训练样本采集方法的模型训练装 置，所述装置包括：

[0032] 正例训练样本确定模块，用于在预设的初始图像检索模型获得的样本集合中，获 取多个目标向量，并确定每个目标向量所对应的一个正例训练样本；

[0033] 负例训练样本确定模块，用于针对所述每个目标向量，在所述样本集合中，确定该 目标向量所对应的多个负例训练样本；

[0034] 训练样本组确定模块，用于确定多组训练样本，其中，每个训练样本包括一个目标 向量、该目标向量所对应的一个正例训练样本和该目标向量所对应的多个负例训练样本；

[0035] 模型训练模块，用于基于所述多组训练样本对所述预设的初始图像检索模型进行 训练，并从零开始对迭代次数进行计数，作为目标次数；

[0036] 目标次数判断模块，用于当所述目标次数达到预设数值时，判断是否满足训练停 止条件，如果满足，触发模型获得模块，否则，触发清零模块和所述负例训练样本确定模块；

[0037] 所述模型获得模块，用于停止模型训练，得到训练完成的图像检索模型；

[0038] 所述清零模块，用于将所述目标次数清零。

[0039] 第五方面，本发明实施例提供了一种电子设备，包括处理器、通信接口、存储器和 通信总线，其中，处理器，通信接口，存储器通过通信总线完成相互间的通信；

[0040] 存储器，用于存放计算机程序；

[0041] 处理器，用于执行存储器上所存放的程序时，实现上述第一方面提供的一种负例 训练样本采集方法中任一所述的方法步骤。

[0042] 第六方面，本发明实施例还提供了另一种电子设备包括处理器、通信接口、存储器 和通信总线，其中，处理器，通信接口，存储器通过通信总线完成相互间的通信；

[0043] 存储器，用于存放计算机程序；

[0044] 处理器，用于执行存储器上所存放的程序时，实现上述第二方面提供的一种基于 第一方面提供的一种负例训练样本采集方法的模型训练方法中任一所述的方法步骤。

[0045] 第七方面，本发明实施例提供了一种计算机可读存储介质，其特征在于，所述计算 机可读存储介质内存储有计算机程序，所述计算机程序被处理器执行时实现上述第一方面 提供的一种负例训练样本采集方法中任一所述的方法步骤。

[0046] 第八方面，本发明实施例还提供了另一种计算机可读存储介质，其特征在于，所述 计算机可读存储介质内存储有计算机程序，所述计算机程序被处理器执行时实现上述第二 方面提供的一种基于第一方面提供的一种负例训练样本采集方法的模型训练方法中任一 所述的方法步骤。

[0047] 以上可见，在本发明实施例提供的一种负例训练样本采集方法中，通过对样本集

说 明 书 3/18 页

CN 109165309 B

合中各个表示向量的聚类，将各个表示向量按照相似度进行分类。从而可以确定每个候选 聚类作为目标向量所属的第一聚类的近邻聚类的概率，也就是可以确定每个候选聚类中的 表示向量作为目标向量的负例训练样本的难度水平。继而，基于该概率确定用于抽取该目 标向量的负例训练样本的第二聚类，便可以兼顾到兼顾各个不同难度水平的负例训练样 本。同时，由于概率较大的聚类中的表示向量为“较难”的负例训练样本，根据概率论的相关 知识，显然，这些概率较大的聚类被抽取为第二聚类的可能性较高。因此，采集负例训练样 本时，不但可以兼顾各个不同难度水平的负例训练样本，还可以优先采集“难”的负例训练 样本。

[0048] 在本发明实施例提供的一种模型训练方法中，考虑到在图像检索模型的训练过程 中，模型的相关参数和权重会发生变化，导致样本集合的聚类结果发生变化，进而导致基于 聚类结果确定的训练样本发生变化，因此，在图像检索模型的训练过程中，可以随着模型的 相关参数和权重的变化，调整对样本集合的聚类结果，使获得的负例训练样本更具有代表 性。同时，在模型训练方法中通过上述负例训练样本采集方法确定训练样本中的负例训练 样本，以使得每次确定的负例训练样本时，可以在兼顾各个不同难度水平的负例训练样本 的同时，优先采集“难”的负例训练样本。进而，可以提高基于获得的负例训练样本训练得到 的图像检索模型的检索准确率。

[0049] 为了更清楚地说明本发明实施例或现有技术中的技术方案，下面将对实施例或现 有技术描述中所需要使用的附图作简单地介绍，显而易见地，下面描述中的附图仅仅是本 发明的一些实施例，对于本领域普通技术人员来讲，在不付出创造性劳动的前提下，还可以 根据这些附图获得其他的附图。

[0050] 图1为本发明实施例提供的一种目标图像周围的负例图像的示意图；

[0051] 图2为本发明实施例提供的一种负例训练样本采集方法的流程示意图；

[0052] 图3为本发明实施例提供的一种基于负例训练样本采集方法的模型训练方法的流 程示意图；

[0053] 图4为本发明实施例提供的一种负例训练样本采集装置的结构示意图；

[0054] 图5为本发明实施例提供的一种基于负例训练样本采集方法的模型训练装置的结 构示意图；

[0055] 图6为本发明实施例提供的一种电子设备；

[0056] 图7为本发明实施例提供的另一种电子设备。

具体实施方式

[0057] 下面将结合本发明实施例中的附图，对本发明实施例中的技术方案进行清楚、完 整地描述，显然，所描述的实施例仅仅是本发明一部分实施例，而不是全部的实施例。基于 本发明中的实施例，本领域普通技术人员在没有做出创造性劳动前提下所获得的所有其他 实施例，都属于本发明保护的范围。

[0058] 当前负例训练样本采集方法，一种是只能采集“难”的负例训练样本，从而导致负 例采样不是在整个样本空间中进行，而只能聚焦于样本空间中的一个局部视角，另一种是

说 明 书 4/18 页

CN 109165309 B

虽然能够进行均匀随机采样，得到所有难度水平的负例训练样本，但是由于“难”的负例训 练样本的训练不充分，训练得到的图像检索模型存在局部最优。也就是说，利用现有技术中 负例训练样本采集方法采集到的负例训练样本对模型进行训练，训练得到的图像检索模型 的检索准确率较低。

[0059] 为了解决现有技术中存在的问题，本发明实施例提供了一种负例训练样本采集方 法、装置及电子设备。

[0060] 下面，首先对本发明实施例提供的一种负例训练样本采集方法进行介绍。

[0061] 需要说明的是，本发明实施例所提供的一种负例训练样本采集方法可以应用于任 意电子设备，例如，可以手机、平板电脑、笔记本电脑、台式电脑等，在此不做具体限定，以下 简称电子设备。

[0062] 图2为本发明实施例提供的一种负例训练样本采集方法的流程示意图，如图2所 示，该负例训练样本采集方法，可以包括如下步骤：

[0063] S201：将用于负例训练样本采集的多张图像输入到预设的初始图像检索模型中， 得到各张图像对应的表示向量，并将所得到的表示向量构成样本集合。

[0064] 其中，上述多张图像可以是预先存储在电子设备的存储空间中的用于负例训练样 本采集的图像，也可以是从与电子设备进行通信连接的其他电子设备处获得的用于负例训 练样本采集的图像，本发明实施例不对上述多张图像的来源进行限定。上述预设的初始图 像检索模型可以是深度神经网络模型，这些深度神经网络模型可以具有不同的结构，例如， VGG16(Visual Geometry Group 16)结构、GoogLeNet结构、ResNet(Residual network，残 差网络)结构、AlexNet结构(Alex在2012年提出的深度神经网络模型的结构)等。

[0065] 可以理解的，在获取用于模型训练的训练样本时，这些训练样本可以是在预先设 置好的样本集合中获取的，而根据实际应用的不同需求以及不同模型所具有的不同的特点 和功能，样本集合中可以包括不同形式的样本，例如，可以是图像、向量、点的坐标等等。

[0066] 而在上述步骤S201中，电子设备并不直接将上述用于负例训练样本采集的多张图 像构成训练集合，而是将这些图像输入到预设的初始图像检索模型中，获得这些图像中各 张图象对应的表示向量，并将所得到的表示向量构成样本集合。这就是说，在上述步骤S201 构成的样本集合中包括的是多个表示向量。

[0067] 例如，预设的初始图像检索模型的网络结构是VGG16结构，进而，移除该VGG16结构 中的所有全连接层，添加全局平均池层和具有L2正则化的全连接层，进而，根据该全局平均 池层和全连接层将224*224*3维的图像映射到128维的表示向量。其中，224*224表示每张图 像具有224行像素，每行像素包括224个像素点，3表示每张图像的图层数量。

[0068] 需要说明的是，上述示例仅用于对上述步骤S201进行说明，并不是对上述步骤 S201的具体限制。对于预设的初始图像检索模型的结构、获得所述多张图像的表示向量的 方式、多张图像的图像格式以及得到的表示向量的维度，本发明实施例均不进行具体限定。

[0069] 例如，表示向量也可以是64维、256维或者512维，具体的，可以根据实际应用中对 图像映射到表示向量的精度需求确定表示向量的维度，当精度需求越大时，表示向量的维 度可以越大，反之，表示向量的维度可以越小。

[0070] S202：对样本集合包括的多个表示向量进行聚类，得到多个聚类，并确定每个聚类 的聚类中心。

说 明 书 5/18 页

CN 109165309 B

[0071] 在得到多个表示向量构成的样本集合后，电子设备可以对该多个表示向量进行聚 类，得到多个聚类，进而，也就可以确定每个聚类的聚类中心及该聚类中心所对应的向量。

[0072] 其中，在上述步骤S202中，电子设备可以采用任一能够对样本集合包括的多个表 示向量进行聚类的聚类算法，例如，AP(Affinity Propagation，亲和传播)聚类算法、K- MEANS(K-均值)算法等。

[0073] 需要说明的是，在对样本集合包括的多个向量进行聚类，得到多个聚类后，得到的 多个聚类可以形成聚类结构，进而，上述初始图像检索模型可以根据该聚类结构更新自身 的相关参数及权重。可以理解的，当初始图像检索模型的相关参数和权重更新后，输入到该 初始图像检索模型中的多张图像对应的表示向量会随着初始图像检索模型的相关参数和 权重的变化而发生变化，进而对样本集合中包括的多个表示向量进行聚类的聚类结果也会 随着变化，最终导致聚类结构发生变化。也就是说，聚类结构在训练过程中会随着上述初始 图像检索模型相关参数和权重的变化而改变。

[0074] 因此，为了得到更好的聚类结构，使得到的负例训练样本更具有代表性，从而提高 训练得到的图像检索模型的检索准确率，在模型训练过程中，电子设备可以随着初始图像 检索模型相关参数和权重的变化，重新对上述样本集合包括的多个表示向量进行聚类，得 到更新后的多个聚类，并基于更新后的聚类获得更新后的负例训练样本，进而，采用更新后 的负例训练样本对上述初始图像检索模型进行训练，得到最终的图像检索模型。

[0075] 可以理解的，由于聚类是指将物理或抽象对象的集合分成由类似的对象组成的多 个类的过程，因此，在步骤S202中，电子设备对多个表示向量进行聚类，也就是，电子设备可 以按照多个表示向量之间的相似度对多个表示向量进行分类，从而将相似度高的表示向量 聚为一类。

[0076] 进一步的，由于每个表示向量都对应于一个用于负例训练样本采集的图像，可以 反映该图像的特征，因此，步骤S202也可以理解为：按照图像相似度对上述多个图像进行分 类，从而将相似度高的图像聚为一类。

[0077] S203：针对每个目标向量，确定该目标向量所属的第一聚类，其中，任一目标向量 为：多张图像中的一张目标图像对应的表示向量；

[0078] 在得到多个聚类后，针对每个目标向量，电子设备可以确定该目标向量所属的第 一聚类。可以理解的，针对每个目标向量，电子设备可以通过多种方式确定该目标向量所属 的第一聚类，对此，本发明实施例不进行具体限定。

[0079] 可选的，一种具体实现方式中，上述步骤S203可以为：

[0080] 针对每个目标向量，确定该目标向量与每个聚类的聚类中心所对应的向量的距 离，将距离最近的聚类确定为该目标向量所属的第一聚类。

[0081] 其中，在对样本集合中包括的多个表示向量进行聚类后，也就可以确定得到的多 个聚类中每个聚类的聚类中心，进而，便可以确定每个聚类的聚类中心所对应的向量。因 此，针对每个目标向量，电子设备便可以计算该目标向量与每个聚类的聚类中心所对应的 向量的距离，并将距离最近的向量所对应的聚类确定为该目标向量所属的第一聚类。

[0082] 可选的，另一种具体实现方式中，上述步骤S203可以包括：

[0083] 针对每个目标向量，可以根据上述步骤S202中对样本集合中的表示向量的聚类结 果确定该目标向量所属的聚类。

说 明 书 6/18 页

CN 109165309 B

[0084] 其中，由于目标向量为上述样本集合中的一个表示向量，因此在上述步骤202对上 述样本集合包括的多个表示向量进行聚类后，该目标向量可以被分到某个聚类中，则该聚 类即为该目标向量所属的聚类。

[0085] 需要说明的是，电子设备在获得上述多张图像时，可以将这些图像中的部分图像 作为目标图像，进而，在执行上述步骤S201后，电子设备可以将得到的与目标图像对应的表 示向量作为目标向量。当然，电子设备也可以在执行上述步骤S201后，在得到的每张图像对 应的表示向量中选取部分表示向量作为目标向量。这都是合理的。

[0086] 可以理解的，电子设备获得的用于负例训练样本采集的多张图像的数量通常较 大，也就是电子设备获得的表示向量的数量也较大，进而，这些表示向量所对应的负例训练 样本的数量可以更大。因此，在图像检索模型训练过程中，电子设备很难将所有图像的负例 训练样本均输入到初始图像检索模型中进行训练。在这种情况下，电子设备便可以将获得 的用于负例训练样本采集的多张图像中的部分图像作为目标图像，从而得到目标向量及目 标向量所对应的负例训练样本，并利用这些负例训练样本对初始图像检索模型进行训练。

[0087] 其中，目标向量的数量可以根据实际应用中对训练得到的图像检索模型的检索准 确率的需求确定，如果对检索准确率的需求较高，则目标向量的数量可以加大，反之，目标 向量的数量可以较小。

[0088] S204：针对每个目标向量，基于该目标向量所属的第一聚类的聚类中心，确定该目 标向量所对应多个候选聚类中的每个聚类的目标概率；

[0089] 其中，多个候选聚类为：多个聚类中，除该目标向量所属的第一聚类外的所有聚 类，任一聚类的目标概率为该聚类作为该目标向量所属的第一聚类的近邻聚类的概率。

[0090] 针对每个目标向量，在确定该目标向量所属的第一聚类后，便可以随之确定该第 一聚类的聚类中心，进而，电子设备便可以执行将上述步骤S202得到的多个聚类中除该第 一聚类外的其他聚类作为该目标向量所对应的多个候选聚类，并基于该第一聚类的聚类中 心，计算每个候选聚类作为该第一聚类的近邻聚类的概率，即每个候选聚类的目标概率。

[0091] 其中，每个候选聚类的目标概率表征了该候选聚类中的表示向量作为目标向量的 负例训练样本的难度，具体的，候选聚类的目标概率越大，表征该候选聚类中的表示向量作 为目标向量的负例训练样本的难度水平越大，也就是该候选聚类中的表示向量与目标向量 的相似度越高。进而，可以理解的，所谓“难度水平”可以表示候选聚类中的表示向量与目标 向量的相似度。

[0092] 需要说明的是，在上述步骤S202中，电子设备按照多个表示向量之间的相似度对 多个表示向量进行分类，从而将相似度高的表示向量聚为一类，因此，每个聚类中的表示向 量相似度较高，进而，目标向量与其所属的第一聚类中的表示向量的相似度也较高。由于同 一个聚类中的表示向量之间的相似度较高，因此，可以根据分别属于两个聚类的两个表示 向量的相似度来反映这两个聚类的相似度，进一步的，可以根据两个聚类的聚类中心所对 应的表示向量的相似度来反映这两个聚类的相似度。可以理解的，不同的聚类间相似度具 有一定差异，也就是说，在上述步骤S202电子设备得到的多个聚类中，每两个聚类的相似度 可以较低，也可以较高。

[0093] 可选的，一种具体实现方式中，上述步骤S204可以为：

[0094] 针对每个目标向量，根据第一公式，计算该目标向量所对应多个候选聚类中的每

说 明 书 7/18 页

CN 109165309 B

个聚类的目标概率，其中，第一公式为：

[0095]

[0096] 其中，P(m,i)为针对第i个目标向量，所对应多个候选聚类中，第m个聚类作为该目 标向量所属的第一聚类的近邻聚类的概率，T为转置运算；

[0097] ci为第i个目标向量所属的第一聚类的聚类中心，cm为第i个目标向量所对应多个 候选聚类中，第m个聚类的聚类中心，cj为第i个目标向量所对应多个候选聚类中，第j个聚 类的聚类中心，M为多个聚类的数量，1≤m≤M且m≠i。

[0098] 当然，在本发明实施例中，电子设备也可以通过其他方式计算每个聚类的目标概 率，对此，本发明实施例不做具体限定。

[0099] S205：针对每个目标向量，基于所确定的目标概率，对该目标向量所对应多个候选 聚类执行多次聚类抽取操作，得到该目标向量对应的多个第二聚类；

[0100] 针对每个目标向量，在确定该目标向量所对应的每个候选聚类的目标概率后，电 子设备便可以基于所确定的目标概率，对该目标向量所对应多个候选聚类执行多次聚类抽 取操作，得到该目标向量对应的多个第二聚类。

[0101] 其中，上述抽取操作为：基于所确定的目标概率，从该目标向量所对应的多个候选 聚类中随机抽取一个聚类作为该目标向量对应的第二聚类。进而，电子设备可以根据实际 应用中对第二聚类的数量需求执行多次抽取操作，得到所需要数量的第二聚类。

[0102] 例如，针对每个目标向量，实际应用中需要确定10个该目标向量对应的第二聚类， 则电子设备便可以基于确定的目标概率，对该目标向量所对应的多个候选聚类执行10次抽 取操作，每次从这多个候选聚类中抽取1个聚类作为第二聚类，共抽取10个。

[0103] 需要说明的是，根据概率论的相关知识，可以理解的，多个候选聚类中每个候选聚 类具有不同的目标概率时，当在这多个候选聚类中抽取一个聚类时，显然，目标概率大的后 续聚类被抽中的几率更大，而目标概率大说明该候选聚类中的表示向量作为目标向量的负 例训练样本的难度水平高，也就是说可以优先采集“难”的负例训练样本。而对于目标概率 小的候选聚类而言，虽然在一次抽取操作中被抽中的几率小，但是由于每次抽取操作都是 随机的在多个候选聚类中抽取一个聚类，则目标概率小的聚类也存在被抽中的可能。由于 不同的目标概率表征了不同的候选聚类中的表示向量作为目标向量的负例样本的难度水 平不同，因此，便可以兼顾到各个不同难度水平的负例训练样本。

[0104] S206：针对每个目标向量，在该目标向量对应的每个第二聚类中获取一个表示向 量，作为该目标向量所对应的负例训练样本。

[0105] 针对每个目标向量，在得到该目标向量对应的多个第二聚类后，电子设备便可以 从每个第二聚类中获取一个表示向量，作为该目标向量所对应的负例训练样本。可以理解 的，电子设备可以通过多重方式在每个第二聚类中获取一个表示向量，对此，本发明实施例 不做具体限定。

[0106] 可选的，一种具体实现方式中，上述步骤S206可以包括：

[0107] 针对每个目标向量，在该目标向量对应的每个第二聚类中随机获取一个表示向 量，作为该目标向量所对应的负例训练样本；

[0108] 可以理解的，由于每个聚类中的各个表示向量之间的相似度较高，因此，针对每个

说 明 书 8/18 页

CN 109165309 B

目标向量，与该目标向量对应的一个第二聚类中的每个表示向量作为该目标向量的负例训 练样本的难度是相同的，进而，电子设备可以在该第二聚类所包括的表示向量中随机抽取 一个作为该目标向量所对应的负例训练样本。

[0109] 可选的，一种具体实现方式中，上述步骤S206可以包括：

[0110] 针对每个目标向量，将该目标向量对应的每个第二聚类中与该第二聚类的聚类中 心的距离为预设距离的表示向量，确定为该目标向量所对应的负例训练样本。

[0111] 可以理解的，由于针对每个目标向量，与该目标向量对应的一个第二聚类中的每 个表示向量作为该目标向量的负例训练样本的难度是相同的，那么电子设备便可以在将该 第二聚类中与该第二聚类的聚类中心的聚类为预设距离的表示向量确定为该目标向量所 对应的负例训练样本。其中，本发明实施例不对上述预设距离进行具体限定。

[0112] 例如，确定为负例训练样本的表示向量可以为：第二聚类中距离聚类中心距离最 远的表示向量，也可以为：第二聚类中距离聚类中心距离最近的表示向量；还可以为：第二 聚类中距离聚类中心的聚类为某个固定值的表示向量。这都是合理的。

[0113] 以上可见，在本发明实施例提供的一种负例训练样本采集方法中，通过对样本集 合中各个表示向量的聚类，将各个表示向量按照相似度进行分类。从而可以确定每个候选 聚类作为目标向量所属的第一聚类的近邻聚类的概率，也就是可以确定每个候选聚类中的 表示向量作为目标向量的负例训练样本的难度水平。继而，基于该概率确定用于抽取该目 标向量的负例训练样本的第二聚类，便可以兼顾到兼顾各个不同难度水平的负例训练样 本。同时，由于概率较大的聚类中的表示向量为“较难”的负例训练样本，根据概率论的相关 知识，显然，这些概率较大的聚类被抽取为第二聚类的可能性较高。因此，采集负例训练样 本时，不但可以兼顾各个不同难度水平的负例训练样本，还可以优先采集“难”的负例训练 样本。

[0114] 对应于上述本发明实施例提供的一种负例训练样本采集方法，本发明实施例还提 供了一种基于上述负例训练样本采集方法的模型训练方法。

[0115] 需要说明的是，由于上述一种负例训练样本采集方法是本发明实施例提供的一种 基于上述负例训练样本采集方法的模型训练方法中的一个具体步骤，因此，上述一种负例 训练样本采集方法与本发明实施例提供的一种基于上述负例训练样本采集方法的模型训 练方法的执行主体为同一电子设备。同时，本发明实施例提供的一种基于上述负例训练样 本采集方法的模型训练方法预设的初始图像检索模型与上述负例训练样本采集方法中预 设的初始图像检索模型为同一初始图像检索模型。

[0116] 图3为本发明实施例提供的一种基于上述负例训练样本采集方法的模型训练方法 的流程示意图，如图3所示，该模型训练方法可以包括如下步骤：

[0117] S301：在预设的初始图像检索模型获得的样本集合中，获取多个目标向量，并确定 每个目标向量所对应的一个正例训练样本；

[0118] 需要说明的是，由于在上述步骤S301中，预设的初始图像检索模型与上述一种负 例训练样本采集方法中预设的初始图像检索模型为同一模型。因此，在上述步骤S301中的 样本集合，即为上述一种负例训练样本采集方法的步骤S201中由用于负例训练样本采集的 多张图像中每张图像对应的表示向量构成的样本集合。

[0119] 电子设备在获得用于负例训练样本采集的多张图像时，可以同时获得该多张图像

说 明 书 9/18 页

CN 109165309 B

中，每张图像与该图像对应的正例训练样本的对应关系。也就是说，对于该多张图像中的某 张图像而言，电子设备可以在该多张图像中确定可以作为该图像对应的正例训练样本的图 像。进而，当可以作为该图像对应的正例训练样本的图像是多张时，电子设备便可以在这多 张可以作为该图像对应的正例训练样本的图像中随机获取一张作为该图像对应的正例训 练样本。

[0120] 进一步的，当得到用于负例训练样本采集的多张图像中每张图像对应的表示向量 时，针对每个目标向量，电子设备也可以确定该每个目标向量所对应的一个正例训练样本。 即针对每个目标向量，在训练样本包括的多个表示向量中确定一个可以作为该目标向量的 正例训练样本的表示向量。

[0121] 可以理解的，电子设备在获得上述多张图像时，可以将这些图像中的部分图像作 为目标图像，进而，在执行上述步骤S301后，电子设备可以在样本集合包括的多个表示向量 中获取与目标图像对应的表示向量作为目标向量。当然，电子设备也可以在执行上述步骤 S301时，在样本集合包括的多个表示向量中选取部分表示向量作为目标向量。这都是合理 的。

[0122] S302：针对每个目标向量，在样本集合中，确定该目标向量所对应的多个负例训练 样本；

[0123] 针对每个目标向量，电子设备在样本集合中确定该目标向量所对应的多个负例训 练样本的方式与上述本发明实施例提供的一种负例训练样本采集方法相同，这里不再赘 述。

[0124] S303：确定多组训练样本，其中，每个训练样本包括一个目标向量、该目标向量所 对应的一个正例训练样本和该目标向量所对应的多个负例训练样本；

[0125] 在获取多个目标向量，并确定每个目标向量的正例训练样本和负例训练样本后， 电子设备可以将一个目标向量，以及该目标向量所对应的一个正例训练样本和多个负例训 练样本确定为一组训练样本。进而，根据在上述步骤S301中，电子设备获取的目标向量的个 数，确定多组训练样本。

[0126] S304：基于多组训练样本对预设的初始图像检索模型进行训练，并从零开始对迭 代次数进行计数，作为目标次数；

[0127] 在确定多组训练样本后，电子设备便可以基于这些训练样本对预设的初始图像检 索模型进行训练，并从零开始对训练过程中的迭代次数进行计数，将该数值作为目标次数。

[0128] 具体的，在得到多组训练样本之后，电子设备可以将多组训练样本作为输入，对初 始图像检索模型进行训练。在训练过程中，初始图像检索模型可以学习每组训练样本的特 征，并针对每组训练样本，输出该组训练样本的向量特征。并在对一组训练样本学习一次 后，将目标次数加1。

[0129] 需要说明的是，电子设备在基于确定的多组训练样本对预设的初始图像检索模型 进行训练的过程中，每组训练样本的学习顺序可以是：按照预设的每组训练样本的学习次 数，在一组训练样本的学习次数达到预设的学习次数后，开始学习下一组训练样本。也可以 是：按照每组训练样本的排列顺序，依次学习每组训练样本，每组训练样本的学习次数为1 次，在所有组的训练样本遍历一次后，再次每组训练样本的排列顺序，依次学习每组训练样 本。这都是合理的。

说 明 书 10/18 页

CN 109165309 B

[0130] S305：当目标次数达到预设数值时，判断是否满足训练停止条件；如果满足，执行 S306，否则，执行S307并返回执行S302；

[0131] S306：停止模型训练，得到训练完成的图像检索模型；

[0132] S307：将目标次数清零。

[0133] 当目标次数达到预设数值时，电子设备可以判断此时初始图像检索模型是否满足 训练停止条件。其中，目标次数可以根据实际应用中对训练得到的图像检索模型的检索准 确率的需求确定，当对检索准确率的需求较高时，目标次数可以较小，反之，目标次数可以 较大。

[0134] 可选的，一种具体实现方式中，上述步骤S305可以为：

[0135] 当目标次数达到预设数值时，判断预设损失函数是否满足预设阈值。

[0136] 具体的，当预设损失函数小于预设阈值时，确定满足训练停止条件，反之，确定不 满足训练停止条件。

[0137] 其中，预设阈值可以根据实际应用中对训练得到的图像检索模型的检索准确率的 需求确定，当对检索准确率的需求较高时，预设阈值可以较小，反之，预设阈值可以较大。

[0138] 具体的，预设损失函数可以为：

[0139]

[0140] 该预设损失函数可以在模型训练过程中可以同时惩罚多个负例训练样本。

[0141] 其中，Γ(θ)为预设损失函数的函数值，γ为平滑因子；

[0142] 针对每组训练样本，xq为该训练样本中的目标向量，x0为该训练样本中的正例训练 样本，xi为该训练样本中的第i个负例训练样本，1≤i≤n，n为该训练样本中负例训练样本 的数量；R(x0,xq)为该训练样本中x0与xq的相似度；R(xi,xq)为该训练样本中xi与xq的相似 度。

[0143] 具体的，上述损失函数中的R(x0,xq)和R(xi,xq)可以通过如下方式计算：

[0144] R(x0，xq)＝f(x0)Tf(xq)

[0145] R(xi，xq)＝f(xi)Tf(xq)

[0146] 其中，f为初始图像检索模型将图像映射到该图像所对应的表示向量的映射函数， T为转置运算。

[0147] 可选的，另一种具体实现方式中，上述步骤S305可以为：

[0148] 当目标次数达到预设数值时，判断迭代总数是否达到预设迭代次数。

[0149] 需要说明的是，电子设备在基于多组训练样本对预设的初始图像检索模型进行训 练的过程中，可以记录该初始图像检索模型在开始训练到当前时刻的总的迭代次数。也就 是说，在初始图像检索模型开始第一次学习训练样本时，从零开始对迭代总数进行计数，并 在对一组训练样本学习一次后，将迭代总数加1，而直至图像检索模型训练完成，该迭代总 数只随着初始图像检索模型对训练样本的学习而增减，但不清零。

[0150] 这样，当目标次数达到预设数值时，电子设备便可以判断迭代总数是否达到预设 迭代次数。

[0151] 当迭代总数不小于预设迭代次数时，确定满足训练停止条件，反之，则确定不满足 训练停止条件。

说 明 书 11/18 页

CN 109165309 B

[0152] 其中，预设迭代次数可以根据实际应用中对训练得到的图像检索模型的检索准确 率的需求确定，当对检索准确率的需求较高时，预设迭代次数可以较大，反之，预设迭代次 数可以较小。

[0153] 具体的，当目标次数达到预设数值时，如果电子设备判断此时初始图像检索模型 满足训练停止条件，则电子设备可以执行步骤S306，停止模型训练，得到训练完成的图像检 索模型。此时，本发明实施例提供的一种基于上述负例训练样本采集方法的模型训练方法 完成，得到训练完成的用于图像检索的图像检索模型。

[0154] 需要说明的是，当初始图像检索模型满足训练停止条件时，经过大量的训练样本 的学习，初始图像检索模型可以建立训练样本与训练样本的向量特征的对应关系，完成了 图像检索模型的训练。用户在使用该图像检索模型时，可以将待检索的图像输入到该图像 检索模型中，这样，便可以得到按照与该待检索图像的相似度由大到小排列的一系列图像。

[0155] 具体的，当目标次数达到预设数值时，电子设备判断此时初始图像检索模型不满 足训练停止条件，则说明初始图像检索模型还建立好训练样本与训练样本的向量特征的对 应关系，进而没有完成图像检索模型的训练，因此，电子设备需要返回执行上述步骤S302， 即针对每个目标向量，在样本集合中，重新确定该目标向量所对应的多个负例训练样本，并 将目标次数清零，以便在再次执行上述步骤S304基于多组训练样本对预设的初始图像检索 模型进行训练时，可以再次并从零开始对迭代次数进行计数，进而再次得到目标次数。

[0156] 以上可见，在本发明实施例提供的一种模型训练方法中，考虑到在图像检索模型 的训练过程中，模型的相关参数和权重会发生变化，导致样本集合的聚类结果发生变化，进 而导致基于聚类结果确定的训练样本发生变化，因此，在图像检索模型的训练过程中，可以 随着模型的相关参数和权重的变化，调整对样本集合的聚类结果，使获得的负例训练样本 更具有代表性。同时，在模型训练方法中通过上述负例训练样本采集方法确定训练样本中 的负例训练样本，以使得每次确定的负例训练样本时，可以在兼顾各个不同难度水平的负

例训练样本的同时，优先采集“难”的负例训练样本。进而，可以提高基于获得的负例训练样 本训练得到的图像检索模型的检索准确率。

[0157] 对应于上述本发明实施例提供的一种负例训练样本采集方法，本发明实施例还提 供了一种负例训练样本采集装置。

[0158] 图4为本发明实施例提供的一种负例训练样本采集装置的结构示意图，如图4所 示，该装置可以包括如下模块：

[0159] 样本集合构成模块410，用于将用于负例训练样本采集的多张图像输入到预设的 初始图像检索模型中，得到各张图像对应的表示向量，并将所得到的表示向量构成样本集 合；

[0160] 聚类中心确定模块420，用于对样本集合包括的多个表示向量进行聚类，得到多个 聚类，并确定每个聚类的聚类中心；

[0161] 第一聚类确定模块430，用于针对每个目标向量，确定该目标向量所属的第一聚 类，其中，任一目标向量为：多张图像中的一张目标图像对应的表示向量；

[0162] 目标概率确定模块440，用于针对每个目标向量，基于该目标向量所属的第一聚类 的聚类中心，确定该目标向量所对应多个候选聚类中的每个聚类的目标概率；其中，多个候 选聚类为：多个聚类中，除该目标向量所属的第一聚类外的所有聚类，任一聚类的目标概率

说 明 书 12/18 页

CN 109165309 B

为该聚类作为该目标向量所属的第一聚类的近邻聚类的概率；

[0163] 第二聚类确定模块450，用于针对每个目标向量，基于所确定的目标概率，对该目 标向量所对应多个候选聚类执行多次聚类抽取操作，得到该目标向量对应的多个第二聚 类；

[0164] 负例训练样本获取模块460，用于针对每个目标向量，在该目标向量对应的每个第 二聚类中获取一个表示向量，作为该目标向量所对应的负例训练样本。

[0165] 以上可见，在本发明实施例提供的一种负例训练样本采集方法中，通过对样本集 合中各个表示向量的聚类，将各个表示向量按照相似度进行分类。从而可以确定每个候选 聚类作为目标向量所属的第一聚类的近邻聚类的概率，也就是可以确定每个候选聚类中的 表示向量作为目标向量的负例训练样本的难度水平。继而，基于该概率确定用于抽取该目 标向量的负例训练样本的第二聚类，便可以兼顾到兼顾各个不同难度水平的负例训练样 本。同时，由于概率较大的聚类中的表示向量为“较难”的负例训练样本，根据概率论的相关 知识，显然，这些概率较大的聚类被抽取为第二聚类的可能性较高。因此，采集负例训练样 本时，不但可以兼顾各个不同难度水平的负例训练样本，还可以优先采集“难”的负例训练 样本。

[0166] 作为本发明实施例的一种实施方式，上述第一聚类确定模块430可以具体用于：

[0167] 针对每个目标向量，确定该目标向量与每个聚类的聚类中心所对应的向量的距 离，将距离最近的聚类确定为该目标向量所属的第一聚类。

[0168] 作为本发明实施例的一种实施方式中，上述目标概率确定模块440可以具体用于：

[0169] 针对每个目标向量，根据第一公式，计算该目标向量所对应多个候选聚类中的每 个聚类的目标概率，其中，第一公式为：

[0170]

[0171] 其中，P(m,i)为针对第i个目标向量，所对应多个候选聚类中，第m个聚类作为该目 标向量所属的第一聚类的近邻聚类的概率，T为转置运算；

[0172] ci为第i个目标向量所属的第一聚类的聚类中心，cm为第i个目标向量所对应多个 候选聚类中，第m个聚类的聚类中心，cj为第i个目标向量所对应多个候选聚类中，第j个聚 类的聚类中心，M为多个聚类的数量，1≤m≤M且m≠i。

[0173] 作为本发明实施例的一种实施方式，上述负例训练样本获取模块460可以具体用 于：

[0174] 针对每个目标向量，在该目标向量对应的每个第二聚类中随机获取一个表示向 量，作为该目标向量所对应的负例训练样本；或，

[0175] 针对每个目标向量，将该目标向量对应的每个第二聚类中与该第二聚类的聚类中 心的距离为预设距离的表示向量，确定为该目标向量所对应的负例训练样本。

[0176] 对应于上述本发明实施例提供的一种基于上述负例训练样本采集方法的模型训 练方法，本发明实施例还提供了一种基于上述负例训练样本采集方法的模型训练装置。

[0177] 图5为本发明实施例提供的一种基于上述负例训练样本采集方法的模型训练装置 的结构示意图，如图5所示，该装置可以包括以下模块：

[0178] 正例训练样本确定模块510，用于在预设的初始图像检索模型获得的样本集合中，

说 明 书 13/18 页

CN 109165309 B

获取多个目标向量，并确定每个目标向量所对应的一个正例训练样本；

[0179] 负例训练样本确定模块520，用于针对每个目标向量，在样本集合中，确定该目标 向量所对应的多个负例训练样本；

[0180] 训练样本组确定模块530，用于确定多组训练样本，其中，每个训练样本包括一个 目标向量、该目标向量所对应的一个正例训练样本和该目标向量所对应的多个负例训练样 本；

[0181] 模型训练模块540，用于基于多组训练样本对预设的初始图像检索模型进行训练， 并从零开始对迭代次数进行计数，作为目标次数；

[0182] 目标次数判断模块550，用于当目标次数达到预设数值时，判断是否满足训练停止 条件，如果满足，触发模型获得模块560，否则，触发清零模块570和负例训练样本确定模块 520；

[0183] 模型获得模块560，用于停止模型训练，得到训练完成的图像检索模型；

[0184] 清零模块570，用于将目标次数清零。

[0185] 在本发明实施例提供的一种模型训练方法中，考虑到在图像检索模型的训练过程 中，模型的相关参数和权重会发生变化，导致样本集合的聚类结果发生变化，进而导致基于 聚类结果确定的训练样本发生变化，因此，在图像检索模型的训练过程中，可以随着模型的 相关参数和权重的变化，调整对样本集合的聚类结果，使获得的负例训练样本更具有代表 性。同时，在模型训练方法中通过上述负例训练样本采集方法确定训练样本中的负例训练 样本，以使得每次确定的负例训练样本时，可以在兼顾各个不同难度水平的负例训练样本 的同时，优先采集“难”的负例训练样本。进而，可以提高基于获得的负例训练样本训练得到 的图像检索模型的检索准确率。

[0186] 作为本发明实施例的一种实施方式，上述目标次数判断模块550可以具体用于：

[0187] 当目标次数达到预设数值时，判断预设损失函数是否满足预设阈值。

[0188] 作为本发明实施例的一种实施方式，上述预设损失函数可以为：

[0189]

[0190] 其中，Γ(θ)为预设损失函数的函数值，γ为平滑因子；

[0191] 针对每组训练样本，xq为该训练样本中的目标向量，x0为该训练样本中的正例训练 样本，xi为该训练样本中的第i个负例训练样本，1≤i≤n，n为该训练样本中负例训练样本 的数量；R(x0,xq)为该训练样本中x0与xq的相似度；R(xi,xq)为该训练样本中xi与xq的相似 度。

[0192] 作为本发明实施例的一种实施方式，

[0193] R(x0,xq)＝f(x0)Tf(xq)

[0194] R(xi,xq)＝f(xi)Tf(xq)

[0195] 其中，f为初始图像检索模型将图像映射到该图像所对应的表示向量的映射函数， T为转置运算。

[0196] 本发明实施例还提供了一种电子设备，如图6所示，包括处理器601、通信接口602、 存储器603和通信总线604，其中，处理器601，通信接口602，存储器603通过通信总线604完 成相互间的通信，

说 明 书 14/18 页

CN 109165309 B

[0197] 存储器603，用于存放计算机程序；

[0198] 处理器601，用于执行存储器603上所存放的程序时，实现本发明实施例提供的一 种负例训练样本采集方法。

[0199] 具体的，上述负例训练样本采集方法，包括：

[0200] 将用于负例训练样本采集的多张图像输入到预设的初始图像检索模型中，得到各 张图像对应的表示向量，并将所得到的表示向量构成样本集合；

[0201] 对样本集合包括的多个表示向量进行聚类，得到多个聚类，并确定每个聚类的聚 类中心；

[0202] 针对每个目标向量，确定该目标向量所属的第一聚类，其中，任一目标向量为：多 张图像中的一张目标图像对应的表示向量；

[0203] 针对每个目标向量，基于该目标向量所属的第一聚类的聚类中心，确定该目标向 量所对应多个候选聚类中的每个聚类的目标概率；其中，多个候选聚类为：多个聚类中，除 该目标向量所属的第一聚类外的所有聚类，任一聚类的目标概率为该聚类作为该目标向量 所属的第一聚类的近邻聚类的概率；

[0204] 针对每个目标向量，基于所确定的目标概率，对该目标向量所对应多个候选聚类 执行多次聚类抽取操作，得到该目标向量对应的多个第二聚类；

[0205] 针对每个目标向量，在该目标向量对应的每个第二聚类中获取一个表示向量，作 为该目标向量所对应的负例训练样本。

[0206] 需要说明的是，上述处理器601执行存储器603上存放的程序而实现的负例训练样 本采集方法的其他实现方式，与前述方法实施例部分提供的一种负例训练样本采集方法实 施例相同，这里不再赘述。

[0207] 以上可见，在本发明实施例提供的一种负例训练样本采集方法中，通过对样本集 合中各个表示向量的聚类，将各个表示向量按照相似度进行分类。从而可以确定每个候选 聚类作为目标向量所属的第一聚类的近邻聚类的概率，也就是可以确定每个候选聚类中的 表示向量作为目标向量的负例训练样本的难度水平。继而，基于该概率确定用于抽取该目 标向量的负例训练样本的第二聚类，便可以兼顾到兼顾各个不同难度水平的负例训练样 本。同时，由于概率较大的聚类中的表示向量为“较难”的负例训练样本，根据概率论的相关 知识，显然，这些概率较大的聚类被抽取为第二聚类的可能性较高。因此，采集负例训练样 本时，不但可以兼顾各个不同难度水平的负例训练样本，还可以优先采集“难”的负例训练 样本。

[0208] 本发明实施例还提供了另一种电子设备，如图7所示，包括处理器701、通信接口 702、存储器703和通信总线704，其中，处理器701，通信接口702，存储器703通过通信总线 704完成相互间的通信，

[0209] 存储器703，用于存放计算机程序；

[0210] 处理器701，用于执行存储器703上所存放的程序时，实现本发明实施例提供的一 种基于上述负例训练样本采集方法的模型训练方法。

[0211] 具体的，上述模型训练方法，包括：

[0212] 在预设的初始图像检索模型获得的样本集合中，获取多个目标向量，并确定每个 目标向量所对应的一个正例训练样本；

说 明 书 15/18 页

CN 109165309 B

[0213] 针对每个目标向量，在样本集合中，确定该目标向量所对应的多个负例训练样本；

[0214] 确定多组训练样本，其中，每个训练样本包括一个目标向量、该目标向量所对应的 一个正例训练样本和该目标向量所对应的多个负例训练样本；

[0215] 基于多组训练样本对预设的初始图像检索模型进行训练，并从零开始对迭代次数 进行计数，作为目标次数；

[0216] 当目标次数达到预设数值时，判断是否满足训练停止条件；

[0217] 如果满足，停止模型训练，得到训练完成的图像检索模型；

[0218] 否则，将目标次数清零，返回针对每个目标向量，在样本集合中，确定该目标向量 所对应的多个负例训练样本的步骤。

[0219] 需要说明的是，上述处理器701执行存储器703上存放的程序而实现的负例训练样 本采集方法的其他实现方式，与前述方法实施例部分提供的一种基于上述负例训练样本采 集方法的模型训练方法实施例相同，这里不再赘述。

[0220] 在本发明实施例提供的一种模型训练方法中，考虑到在图像检索模型的训练过程 中，模型的相关参数和权重会发生变化，导致样本集合的聚类结果发生变化，进而导致基于 聚类结果确定的训练样本发生变化，因此，在图像检索模型的训练过程中，可以随着模型的 相关参数和权重的变化，调整对样本集合的聚类结果，使获得的负例训练样本更具有代表 性。同时，在模型训练方法中通过上述负例训练样本采集方法确定训练样本中的负例训练 样本，以使得每次确定的负例训练样本时，可以在兼顾各个不同难度水平的负例训练样本 的同时，优先采集“难”的负例训练样本。进而，可以提高基于获得的负例训练样本训练得到 的图像检索模型的检索准确率。

[0221] 上述电子设备提到的通信总线可以是外设部件互连标准(Peripheral Component Interconnect ，PCI) 总线或扩展工业标准结构(Extended Industry Standard Architecture，EISA)总线等。该通信总线可以分为地址总线、数据总线、控制总线等。为便 于表示，图中仅用一条粗线表示，但并不表示仅有一根总线或一种类型的总线。

[0222] 通信接口用于上述电子设备与其他设备之间的通信。

[0223] 存储器可以包括随机存取存储器(Random Access Memory，RAM)，也可以包括非易 失性存储器(Non-Volatile Memory，NVM)，例如至少一个磁盘存储器。可选的，存储器还可 以是至少一个位于远离前述处理器的存储装置。

[0224] 上述的处理器可以是通用处理器，包括中央处理器(Central Processing Unit， CPU)、网络处理器(Network Processor，NP)等；还可以是数字信号处理器(Digital Signal Processing，DSP)、专用集成电路(Application Specific Integrated Circuit，ASIC)、现 场可编程门阵列(Field-Programmable Gate Array，FPGA)或者其他可编程逻辑器件、分立 门或者晶体管逻辑器件、分立硬件组件。

[0225] 本发明实施例还提供了一种计算机可读存储介质，该计算机可读存储介质为服务 器中的存储介质，其中存储有计算机程序，该计算机程序被处理器执行时实现本发明实施 例提供的一种负例训练样本采集方法。

[0226] 具体的，上述负例训练样本采集方法，包括：

[0227] 将用于负例训练样本采集的多张图像输入到预设的初始图像检索模型中，得到各 张图像对应的表示向量，并将所得到的表示向量构成样本集合；

说 明 书 16/18 页

CN 109165309 B

[0228] 对样本集合包括的多个表示向量进行聚类，得到多个聚类，并确定每个聚类的聚 类中心；

[0229] 针对每个目标向量，确定该目标向量所属的第一聚类，其中，任一目标向量为：多 张图像中的一张目标图像对应的表示向量；

[0230] 针对每个目标向量，基于该目标向量所属的第一聚类的聚类中心，确定该目标向 量所对应多个候选聚类中的每个聚类的目标概率；其中，多个候选聚类为：多个聚类中，除 该目标向量所属的第一聚类外的所有聚类，任一聚类的目标概率为该聚类作为该目标向量 所属的第一聚类的近邻聚类的概率；

[0231] 针对每个目标向量，基于所确定的目标概率，对该目标向量所对应多个候选聚类 执行多次聚类抽取操作，得到该目标向量对应的多个第二聚类；

[0232] 针对每个目标向量，在该目标向量对应的每个第二聚类中获取一个表示向量，作 为该目标向量所对应的负例训练样本。

[0233] 需要说明的是，上述计算机程序被处理器执行时而实现的负例训练样本采集方法 的其他实现方式，与前述方法实施例部分提供的一种负例训练样本采集方法实施例相同， 这里不再赘述。

[0234] 以上可见，在本发明实施例提供的一种负例训练样本采集方法中，通过对样本集 合中各个表示向量的聚类，将各个表示向量按照相似度进行分类。从而可以确定每个候选 聚类作为目标向量所属的第一聚类的近邻聚类的概率，也就是可以确定每个候选聚类中的 表示向量作为目标向量的负例训练样本的难度水平。继而，基于该概率确定用于抽取该目 标向量的负例训练样本的第二聚类，便可以兼顾到兼顾各个不同难度水平的负例训练样 本。同时，由于概率较大的聚类中的表示向量为“较难”的负例训练样本，根据概率论的相关 知识，显然，这些概率较大的聚类被抽取为第二聚类的可能性较高。因此，采集负例训练样 本时，不但可以兼顾各个不同难度水平的负例训练样本，还可以优先采集“难”的负例训练 样本。

[0235] 本发明实施例还提供了另一种计算机可读存储介质，该计算机可读存储介质为服 务器中的存储介质，其中存储有计算机程序，该计算机程序被处理器执行时实现本发明实 施例提供的一种基于上述负例训练样本采集方法的模型训练方法。

[0236] 具体的，上述模型训练方法，包括：

[0237] 在预设的初始图像检索模型获得的样本集合中，获取多个目标向量，并确定每个 目标向量所对应的一个正例训练样本；

[0238] 针对每个目标向量，在样本集合中，确定该目标向量所对应的多个负例训练样本；

[0239] 确定多组训练样本，其中，每个训练样本包括一个目标向量、该目标向量所对应的 一个正例训练样本和该目标向量所对应的多个负例训练样本；

[0240] 基于多组训练样本对预设的初始图像检索模型进行训练，并从零开始对迭代次数 进行计数，作为目标次数；

[0241] 当目标次数达到预设数值时，判断是否满足训练停止条件；

[0242] 如果满足，停止模型训练，得到训练完成的图像检索模型；

[0243] 否则，将目标次数清零，返回针对每个目标向量，在样本集合中，确定该目标向量 所对应的多个负例训练样本的步骤。

说 明 书 17/18 页

CN 109165309 B

[0244] 需要说明的是，上述计算机程序被处理器执行时而实现的基于上述负例训练样本 采集方法的模型训练方法的其他实现方式，与前述方法实施例部分提供的一种基于上述负 例训练样本采集方法的模型训练方法实施例相同，这里不再赘述。

[0245] 在本发明实施例提供的一种模型训练方法中，考虑到在图像检索模型的训练过程 中，模型的相关参数和权重会发生变化，导致样本集合的聚类结果发生变化，进而导致基于 聚类结果确定的训练样本发生变化，因此，在图像检索模型的训练过程中，可以随着模型的 相关参数和权重的变化，调整对样本集合的聚类结果，使获得的负例训练样本更具有代表 性。同时，在模型训练方法中通过上述负例训练样本采集方法确定训练样本中的负例训练 样本，以使得每次确定的负例训练样本时，可以在兼顾各个不同难度水平的负例训练样本 的同时，优先采集“难”的负例训练样本。进而，可以提高基于获得的负例训练样本训练得到 的图像检索模型的检索准确率。

[0246] 需要说明的是，在本文中，诸如第一和第二等之类的关系术语仅仅用来将一个实 体或者操作与另一个实体或操作区分开来，而不一定要求或者暗示这些实体或操作之间存 在任何这种实际的关系或者顺序。而且，术语“包括”、 “包含”或者其任何其他变体意在涵盖 非排他性的包含，从而使得包括一系列要素的过程、方法、物品或者设备不仅包括那些要 素，而且还包括没有明确列出的其他要素，或者是还包括为这种过程、方法、物品或者设备 所固有的要素。在没有更多限制的情况下，由语句“包括一个……”限定的要素，并不排除在 包括所述要素的过程、方法、物品或者设备中还存在另外的相同要素。

[0247] 本说明书中的各个实施例均采用相关的方式描述，各个实施例之间相同相似的部 分互相参见即可，每个实施例重点说明的都是与其他实施例的不同之处。尤其，对于装置实 施例、电子设备实施例、计算机可读存储介质实施例而言，由于其基本相似于方法实施例， 所以描述的比较简单，相关之处参见方法实施例的部分说明即可。

[0248] 以上所述仅为本发明的较佳实施例而已，并非用于限定本发明的保护范围。凡在 本发明的精神和原则之内所作的任何修改、等同替换、改进等，均包含在本发明的保护范围 内。

说 明 书 18/18 页

CN 109165309 B

说 明 书 附 图 1/3 页

CN 109165309 B

说 明 书 附 图 2/3 页

CN 109165309 B

说 明 书 附 图 3/3 页

CN 109165309 B